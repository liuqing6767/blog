# HTTP Cache

本文描述 HTTP Cache 的规范，相关RFC在 [HTTP Caching](https://datatracker.ietf.org/doc/html/rfc9114)。主要内容为：
- Cache的基本概念
- HTTP中处理Cache的基本框架
- HTTP中处理Cache的具体协议
- 相关安全问题

## 基本概念
`HTTP缓存` 是指将HTTP的响应的一个本地存 和 控制、检索、删除消息的子系统。

`共享缓存`是被多个用户复用的缓存，通常作为中间节点部署；`私有缓存`是被单个用户使用的，通常部署为用户代理的一部分。

HTTP缓存的目标是 通过复用先前的响应，来减少未来等价的请求的 响应数据和网络带宽、提高性能。

`cache key` 是用来挑选响应的信息，最少有由请求的方法和目标URI组成。

## 基本框架
除非如下情况，响应一定不能缓存：
- 请求Method被理解 （一般为 GET，所谓的安全的）
- 响应码是最终响应码
- 如果响应码是206/304，或者必须理解的缓存指令出现：缓存理解响应码
- 响应中没有 no-store 缓存指令
- 缓存是共享的：私有响应增量没有出现或者允许共享缓存来储存一个被修改后的响应
- 缓存是共享的：Authorization header 没在请求头中出现，或者响应头中出现了确切的可以共享的指令
- 响应至少包含：
    - 一个 public 响应指令
    - 一个私有的响应指令，如果缓存不共享
    - 有 Expires header
    - 如果缓存是共享的：有 s-maxage 响应指令
    - 存在允许被缓存的扩展
    - 被定义为明确可缓存的状态码

缓存必须包括收到的私有的响应Header和 Trailer 字段，包括未识别的，以确保新的HTTP Header能够被成功的部署，除非：
- Connection Header相关的字段，应该在转发在前被移除，可能发生在缓存储存前
- 类似的在转发在前会被移除掉的字段
- no-cache 和 private 缓存指令，可以分别具有防止所有缓存和共享缓存存储头字段的参数。


## 具体协议


## 安全问题
缓存机制暴露了额外的攻击面，因为缓存内容是恶意利用的攻击目标。

缓存内容在请求结束后还会长期存在，因此需要对敏感内容进行保护。

**缓存中毒** 是指 在缓存中存储恶意内容，可以扩展攻击者的影响范围从而影响多个用户。当攻击者使用实现缺陷、提升特权或其他技术将响应插入缓存时，就会发生这种“缓存中毒”攻击。当使用共享缓存向许多客户机分发恶意内容时，这一点尤其有效。 缓存中毒的一个常见攻击向量是利用代理和用户代理在消息解析上的差异。

**定时攻击** 缓存可能会“泄漏”曾经访问的资源的信息。例如用户访问一个站点，他们的浏览器缓存了一些响应，然后导航到第二个站点，该站点可以尝试加载它知道存在于第一个站点上的响应。如果它们加载得很快，就可以假定用户访问了该站点，甚至是其中的特定页面。将引用站点的信息加入cache key 中可以缓解这个问题。

**缓存私密数据** 因为实现和部署的缺陷，可能导致隐私数据被缓存。